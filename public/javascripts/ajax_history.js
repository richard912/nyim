//https://gist.github.com/782275function historySupport() {    return !!(window.history && window.history.pushState !== undefined);}function pushPageState(state, title, href) {    if (historySupport()) {        history.pushState(state, title, href);    }}function replacePageState(state, title, href) {    if (state == undefined) {        state = null;    }    if (historySupport()) {        history.replaceState(state, title, href);    }}$(function() {    window.onpopstate = function(e) {        if ($('body').attr('data-state-href') === location.href) {            //alert('same state; do nottin')            return false;        }        if (e.state !== null) {            // do something with your state object        }        $.ajax({            url: location.href,            dataType: 'script',            // VT spinner when ajaxing via back/forward navigation            //beforeSend: function(xhr, status, error) {                //$('#spinner').fadeIn(2000);                //alert('ajaxing to: ' + location.href)            //},            success: function(data, status, xhr) {                $('body').trigger('ajax:success');            },            error: function(xhr, status, error) {                // You may want to do something else depending on the stored state                alert('Failed to load ' + location.href);            },            complete: function(xhr, status) {                // VT: this part is needed to get rid of dimmer if user navigates away from login page in ajax                if ($('body').attr('data-state-href').match(/sign_in/)) {                    $('#dimmer').hide();                    $('#loginbox').hide();                }                ;                //alert('state: ' + location.href)                $('body').attr('data-state-href', location.href);            }        });    };    var getA = 'a[data-remote][data-method!="put"][data-method!="post"][data-method!="delete"]'        , getForm = 'form[data-remote][method="get"]';    //nongetForm = 'form[data-remote][method!="get"]';    function getState(el) {        // insert your own code here to extract a relevant state object from an <a> or <form> tag        // for example, if you rely on any other custom "data-" attributes to determine the link behaviour        return {};    }    //alert('initial page state: ' + location.href)    $('body').attr('data-state-href', location.href);    $(getA).        livequery('ajax:beforeSend', function(xhr) {            window.title = "Loading...";            pushPageState(getState(this), window.title, this.href);            //alert(['link', getState(this), window.title, this.href].join(', '));        });    $(getForm).        livequery('ajax:beforeSend', function(xhr) {            window.title = "Loading...";            var href = $(this).attr("action") + "?" + $(this).serialize();            //alert(['getform:', getState(this), window.title, href].join(', '));            pushPageState(getState(this), window.title, href);        });    $(getA + ',' + getForm).        live('ajax:complete', function(xhr) {            $('body').attr('data-state-href', location.href);            //window.title = document.title;            replacePageState(getState(this), window.title, location.href);            //alert(['link', getState(this), window.title, location.href].join(', '));        });});